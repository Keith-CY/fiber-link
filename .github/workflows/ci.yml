name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  test-service:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.1.8
      - name: Install dependencies
        working-directory: fiber-link-service
        run: bun install --frozen-lockfile
      - name: Check db migration drift
        working-directory: fiber-link-service/packages/db
        run: bun run db:validate
      - name: Test rpc
        working-directory: fiber-link-service/apps/rpc
        run: bun run test -- --run --silent
      - name: Test admin
        working-directory: fiber-link-service/apps/admin
        run: bun run test -- --run --silent
      - name: Test worker
        working-directory: fiber-link-service/apps/worker
        run: bun run test -- --run --silent
      - name: Test db
        working-directory: fiber-link-service/packages/db
        run: bun run test -- --run --silent

  plugin-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      # Pin Discourse ref to reduce upstream-induced CI breakage. Update as needed.
      DISCOURSE_REF: 26f3e2aa87a3abb35849183e0740fe7ab84cec67
      DISCOURSE_DEV_IMAGE: discourse/discourse_dev:release
      # Keep request spec scope explicit in CI; add more paths via PLUGIN_SMOKE_EXTRA_SPECS as needed.
      PLUGIN_SMOKE_REQUEST_SPECS: "plugins/fiber-link/spec/requests/fiber_link_spec.rb plugins/fiber-link/spec/requests/fiber_link/rpc_controller_spec.rb"
      PLUGIN_SMOKE_EXTRA_SPECS: ""
    steps:
      - uses: actions/checkout@v4

      - name: Checkout Discourse (pinned)
        run: |
          git clone https://github.com/discourse/discourse.git discourse-dev
          cd discourse-dev
          git checkout "$DISCOURSE_REF"

      - name: Copy plugin into Discourse plugins/
        run: |
          rm -rf discourse-dev/plugins/fiber-link
          cp -R fiber-link-discourse-plugin discourse-dev/plugins/fiber-link

      - name: Start Discourse dev container
        working-directory: discourse-dev
        run: |
          docker pull "$DISCOURSE_DEV_IMAGE"
          mkdir -p data/postgres
          chmod -R 777 data/postgres
          docker run -d \
            --name discourse_dev \
            --hostname discourse \
            -v "$PWD/data/postgres:/shared/postgres_data" \
            -v "$PWD:/src" \
            -e UNICORN_BIND_ALL=true \
            "$DISCOURSE_DEV_IMAGE" /sbin/boot

      - name: Fix checkout permissions for container user
        working-directory: discourse-dev
        run: |
          docker exec -u root discourse_dev bash -lc \
            "chown -R discourse:discourse /src && chmod -R u+rwX /src"

      - name: Install Discourse gems
        working-directory: discourse-dev
        run: docker exec -u discourse:discourse -w /src discourse_dev bundle install

      - name: Install Discourse JS deps
        working-directory: discourse-dev
        run: docker exec -u discourse:discourse -w /src discourse_dev pnpm install

      - name: Wait for Postgres
        working-directory: discourse-dev
        run: |
          docker exec -u root discourse_dev bash -lc \
            'for i in {1..180}; do [ -S /var/run/postgresql/.s.PGSQL.5432 ] && exit 0; sleep 1; done; echo "postgres socket not ready after 180s"; exit 1'
          docker logs discourse_dev | tail -n 200 || true

      - name: Prepare test DB
        working-directory: discourse-dev
        run: docker exec -u discourse:discourse -w /src -e RAILS_ENV=test -e LOAD_PLUGINS=1 discourse_dev bin/rake db:create db:migrate

      - name: Plugin smoke spec (requests + optional extras)
        working-directory: discourse-dev
        run: |
          docker exec -u discourse:discourse -w /src \
            -e RAILS_ENV=test -e LOAD_PLUGINS=1 \
            -e PLUGIN_SMOKE_REQUEST_SPECS -e PLUGIN_SMOKE_EXTRA_SPECS \
            discourse_dev bash -lc '
              set -euo pipefail

              specs=($PLUGIN_SMOKE_REQUEST_SPECS)
              if [ -n "${PLUGIN_SMOKE_EXTRA_SPECS:-}" ]; then
                specs+=($PLUGIN_SMOKE_EXTRA_SPECS)
              fi

              bundle exec rspec "${specs[@]}"
            '

      - name: Shutdown Discourse dev container
        if: always()
        run: docker rm -f discourse_dev
