name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  test-service:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.1.8
      - name: Install dependencies
        working-directory: fiber-link-service
        run: bun install --frozen-lockfile
      - name: Test rpc
        working-directory: fiber-link-service/apps/rpc
        run: bun run test -- --run --silent
      - name: Test admin
        working-directory: fiber-link-service/apps/admin
        run: bun run test -- --run --silent
      - name: Test worker
        working-directory: fiber-link-service/apps/worker
        run: bun run test -- --run --silent
      - name: Test db
        working-directory: fiber-link-service/packages/db
        run: bun run test -- --run --silent

  plugin-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      # Pin Discourse ref to reduce upstream-induced CI breakage. Update as needed.
      DISCOURSE_REF: 26f3e2aa87a3abb35849183e0740fe7ab84cec67
      DISCOURSE_DEV_IMAGE: discourse/discourse_dev:release
    steps:
      - uses: actions/checkout@v4

      - name: Checkout Discourse (pinned)
        run: |
          git clone https://github.com/discourse/discourse.git discourse-dev
          cd discourse-dev
          git checkout "$DISCOURSE_REF"

      - name: Copy plugin into Discourse plugins/
        run: |
          rm -rf discourse-dev/plugins/fiber-link-discourse-plugin
          cp -R fiber-link-discourse-plugin discourse-dev/plugins/fiber-link-discourse-plugin

      - name: Start Discourse dev container
        working-directory: discourse-dev
        run: |
          docker pull "$DISCOURSE_DEV_IMAGE"
          mkdir -p data/postgres
          docker run -d \
            --name discourse_dev \
            --hostname discourse \
            -v "$PWD/data/postgres:/shared/postgres_data" \
            -v "$PWD:/src" \
            -e UNICORN_BIND_ALL=true \
            "$DISCOURSE_DEV_IMAGE" /sbin/boot

      - name: Fix checkout permissions for container user
        working-directory: discourse-dev
        run: |
          docker exec -u root discourse_dev bash -lc \
            "chown -R discourse:discourse /src /shared/postgres_data && chmod -R u+rwX /src /shared/postgres_data"

      - name: Install Discourse gems
        working-directory: discourse-dev
        run: docker exec -u discourse:discourse -w /src discourse_dev bundle install

      - name: Install Discourse JS deps
        working-directory: discourse-dev
        run: docker exec -u discourse:discourse -w /src discourse_dev pnpm install

      - name: Prepare test DB
        working-directory: discourse-dev
        run: docker exec -u discourse:discourse -w /src -e RAILS_ENV=test -e LOAD_PLUGINS=1 discourse_dev bin/rake db:create db:migrate

      - name: Plugin smoke spec (requests)
        working-directory: discourse-dev
        run: docker exec -u discourse:discourse -w /src -e RAILS_ENV=test -e LOAD_PLUGINS=1 discourse_dev bin/rspec plugins/fiber-link-discourse-plugin/spec/requests/fiber_link_spec.rb

      - name: Shutdown Discourse dev container
        if: always()
        run: docker rm -f discourse_dev
